#!/usr/bin/env bash

set -e

if ! ps axo command \
	| grep -qE '^/usr/bin/python /usr/bin/supervisord'
then
	>&2 printf -- \
		'%s\n' \
		"supervisord not running."
	exit 1
fi

if [[ ${MEMCACHED_AUTOSTART_MEMCACHED_WRAPPER} == true ]]
then
	if ! ps axo command \
		| grep -qE '^/usr/bin/memcached '
	then
		>&2 printf -- \
			'%s\n' \
			"memcached not running."
		exit 1
	fi

	if ! memcached-tool \
			127.0.0.1:11211 \
			stats \
		| grep -qP \
			'[ ]+accepting_conns[ ]+1[^0-9]*$'
	then
		>&2 printf -- \
			'%s\n' \
			"memcached not accepting connections."
		exit 1
	fi
fi

exit 0
